<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="8162.5px" preserveAspectRatio="none" style="width:3165px;height:8162px;background:#FFFFFF;" version="1.1" viewBox="0 0 3165 8162" width="3165px" zoomAndPan="magnify"><defs/><g><rect fill="#FFD700" height="7692.0898" style="stroke:#A80036;stroke-width:2.5;" width="25" x="170" y="239.0234"/><rect fill="#FFC0CB" height="35" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="528.418"/><rect fill="#FFC0CB" height="1310.0781" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="639.2969"/><rect fill="#FFC0CB" height="35" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="2542.2852"/><rect fill="#FFC0CB" height="1832.2461" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="2653.1641"/><rect fill="#FFC0CB" height="35" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="4683.9258"/><rect fill="#FFC0CB" height="3113.8086" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="4794.8047"/><rect fill="#ADD8E6" height="913.0469" style="stroke:#A80036;stroke-width:2.5;" width="25" x="1552.5" y="837.8125"/><rect fill="#ADD8E6" height="775.5469" style="stroke:#A80036;stroke-width:2.5;" width="25" x="1552.5" y="3429.5898"/><rect fill="#ADD8E6" height="915.5469" style="stroke:#A80036;stroke-width:2.5;" width="25" x="1552.5" y="6327.5195"/><rect fill="#ADD8E6" height="6130.8594" style="stroke:#A80036;stroke-width:2.5;" width="25" x="2197.5" y="913.6914"/><rect fill="#90EE90" height="338.5156" style="stroke:#A80036;stroke-width:2.5;" width="25" x="2460" y="2810.8008"/><rect fill="#90EE90" height="863.7891" style="stroke:#A80036;stroke-width:2.5;" width="25" x="2460" y="5224.3359"/><rect fill="#90EE90" height="227.6367" style="stroke:#A80036;stroke-width:2.5;" width="25" x="2460" y="7359.8242"/><rect fill="#90EE90" height="7692.0898" style="stroke:#A80036;stroke-width:2.5;" width="25" x="3062.5" y="239.0234"/><rect fill="#FFFFFF" height="349.3945" style="stroke:#000000;stroke-width:5.0;" width="935" x="1361.25" y="1246.3281"/><rect fill="#FFFFFF" height="582.9102" style="stroke:#000000;stroke-width:5.0;" width="935" x="1361.25" y="3467.0898"/><rect fill="#FFFFFF" height="308.5156" style="stroke:#000000;stroke-width:5.0;" width="935" x="1361.25" y="6365.0195"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:5.0,5.0;" x1="182.5" x2="182.5" y1="214.0234" y2="7953.6133"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:5.0,5.0;" x1="831.25" x2="831.25" y1="214.0234" y2="7953.6133"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:5.0,5.0;" x1="1563.75" x2="1563.75" y1="214.0234" y2="7953.6133"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:5.0,5.0;" x1="2208.75" x2="2208.75" y1="214.0234" y2="7953.6133"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:5.0,5.0;" x1="2471.25" x2="2471.25" y1="214.0234" y2="7953.6133"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:5.0,5.0;" x1="3073.75" x2="3073.75" y1="214.0234" y2="7953.6133"/><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="325" x="12.5" y="206.333">Ticketing Application</text><ellipse cx="182.5" cy="37.5" fill="#FFD700" rx="20" ry="20" style="stroke:#A80036;stroke-width:5.0;"/><path d="M182.5,57.5 L182.5,125 M150,77.5 L215,77.5 M182.5,125 L150,162.5 M182.5,125 L215,162.5 " fill="none" style="stroke:#A80036;stroke-width:5.0;"/><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="325" x="12.5" y="7987.4463">Ticketing Application</text><ellipse cx="182.5" cy="8020.1367" fill="#FFD700" rx="20" ry="20" style="stroke:#A80036;stroke-width:5.0;"/><path d="M182.5,8040.1367 L182.5,8107.6367 M150,8060.1367 L215,8060.1367 M182.5,8107.6367 L150,8145.1367 M182.5,8107.6367 L215,8145.1367 " fill="none" style="stroke:#A80036;stroke-width:5.0;"/><rect fill="#FFC0CB" height="123.0469" style="stroke:#A80036;stroke-width:3.75;" width="412.5" x="626.25" y="88.4766"/><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="340" x="662.5" y="142.3096">Keyple Core Services</text><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="377.5" x="643.75" y="186.333">Calypso Card Extension</text><rect fill="#FFC0CB" height="123.0469" style="stroke:#A80036;stroke-width:3.75;" width="412.5" x="626.25" y="7951.1133"/><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="340" x="662.5" y="8004.9463">Keyple Core Services</text><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="377.5" x="643.75" y="8048.9697">Calypso Card Extension</text><rect fill="#ADD8E6" height="79.0234" style="stroke:#A80036;stroke-width:3.75;" width="357.5" x="1386.25" y="132.5"/><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="322.5" x="1403.75" y="186.333">Keyple Card Reader</text><rect fill="#ADD8E6" height="79.0234" style="stroke:#A80036;stroke-width:3.75;" width="357.5" x="1386.25" y="7951.1133"/><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="322.5" x="1403.75" y="8004.9463">Keyple Card Reader</text><text fill="#000000" font-family="sans-serif" font-size="35" font-weight="bold" lengthAdjust="spacing" textLength="82.5" x="2161.25" y="206.333">Card</text><path d="M2158.75,100 L2158.75,160 M2158.75,130 L2201.25,130 " fill="none" style="stroke:#A80036;stroke-width:5.0;"/><ellipse cx="2231.25" cy="130" fill="#ADD8E6" rx="30" ry="30" style="stroke:#A80036;stroke-width:5.0;"/><text fill="#000000" font-family="sans-serif" font-size="35" font-weight="bold" lengthAdjust="spacing" textLength="82.5" x="2161.25" y="7987.4463">Card</text><path d="M2158.75,8005.1367 L2158.75,8065.1367 M2158.75,8035.1367 L2201.25,8035.1367 " fill="none" style="stroke:#A80036;stroke-width:5.0;"/><ellipse cx="2231.25" cy="8035.1367" fill="#ADD8E6" rx="30" ry="30" style="stroke:#A80036;stroke-width:5.0;"/><rect fill="#90EE90" height="79.0234" style="stroke:#A80036;stroke-width:3.75;" width="352.5" x="2296.25" y="132.5"/><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="317.5" x="2313.75" y="186.333">Keyple SAM Reader</text><rect fill="#90EE90" height="79.0234" style="stroke:#A80036;stroke-width:3.75;" width="352.5" x="2296.25" y="7951.1133"/><text fill="#000000" font-family="sans-serif" font-size="35" lengthAdjust="spacing" textLength="317.5" x="2313.75" y="8004.9463">Keyple SAM Reader</text><text fill="#000000" font-family="sans-serif" font-size="35" font-weight="bold" lengthAdjust="spacing" textLength="77.5" x="3028.75" y="206.333">SAM</text><path d="M3023.75,100 L3023.75,160 M3023.75,130 L3066.25,130 " fill="none" style="stroke:#A80036;stroke-width:5.0;"/><ellipse cx="3096.25" cy="130" fill="#90EE90" rx="30" ry="30" style="stroke:#A80036;stroke-width:5.0;"/><text fill="#000000" font-family="sans-serif" font-size="35" font-weight="bold" lengthAdjust="spacing" textLength="77.5" x="3028.75" y="7987.4463">SAM</text><path d="M3023.75,8005.1367 L3023.75,8065.1367 M3023.75,8035.1367 L3066.25,8035.1367 " fill="none" style="stroke:#A80036;stroke-width:5.0;"/><ellipse cx="3096.25" cy="8035.1367" fill="#90EE90" rx="30" ry="30" style="stroke:#A80036;stroke-width:5.0;"/><rect fill="#FFD700" height="7692.0898" style="stroke:#A80036;stroke-width:2.5;" width="25" x="170" y="239.0234"/><rect fill="#FFC0CB" height="35" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="528.418"/><rect fill="#FFC0CB" height="1310.0781" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="639.2969"/><rect fill="#FFC0CB" height="35" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="2542.2852"/><rect fill="#FFC0CB" height="1832.2461" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="2653.1641"/><rect fill="#FFC0CB" height="35" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="4683.9258"/><rect fill="#FFC0CB" height="3113.8086" style="stroke:#A80036;stroke-width:2.5;" width="25" x="820" y="4794.8047"/><rect fill="#ADD8E6" height="913.0469" style="stroke:#A80036;stroke-width:2.5;" width="25" x="1552.5" y="837.8125"/><rect fill="#ADD8E6" height="775.5469" style="stroke:#A80036;stroke-width:2.5;" width="25" x="1552.5" y="3429.5898"/><rect fill="#ADD8E6" height="915.5469" style="stroke:#A80036;stroke-width:2.5;" width="25" x="1552.5" y="6327.5195"/><rect fill="#ADD8E6" height="6130.8594" style="stroke:#A80036;stroke-width:2.5;" width="25" x="2197.5" y="913.6914"/><rect fill="#90EE90" height="338.5156" style="stroke:#A80036;stroke-width:2.5;" width="25" x="2460" y="2810.8008"/><rect fill="#90EE90" height="863.7891" style="stroke:#A80036;stroke-width:2.5;" width="25" x="2460" y="5224.3359"/><rect fill="#90EE90" height="227.6367" style="stroke:#A80036;stroke-width:2.5;" width="25" x="2460" y="7359.8242"/><rect fill="#90EE90" height="7692.0898" style="stroke:#A80036;stroke-width:2.5;" width="25" x="3062.5" y="239.0234"/><rect fill="#EEEEEE" height="7.5" style="stroke:#EEEEEE;stroke-width:2.5;" width="3148.75" x="0" y="291.9629"/><line style="stroke:#000000;stroke-width:2.5;" x1="0" x2="3148.75" y1="291.9629" y2="291.9629"/><line style="stroke:#000000;stroke-width:2.5;" x1="0" x2="3148.75" y1="299.4629" y2="299.4629"/><rect fill="#EEEEEE" height="60.8789" style="stroke:#000000;stroke-width:5.0;" width="522.5" x="1313.125" y="264.0234"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="477.5" x="1328.125" y="307.7612">Card selection &amp; identification</text><polygon fill="#A80036" points="790,518.418,815,528.418,790,538.418,800,528.418" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="195" x2="805" y1="528.418" y2="528.418"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="125" x="212.5" y="393.6401">prepare</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="345" x="347.5" y="393.6401">card selection scenario:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="307.5" x="292.5" y="434.519">- filter by specific AID</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="315" x="292.5" y="475.3979">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="330" x="292.5" y="516.2769">- read contracts list file</text><polygon fill="#A80036" points="222.5,553.418,197.5,563.418,222.5,573.418,212.5,563.418" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="207.5" x2="830" y1="563.418" y2="563.418"/><polygon fill="#A80036" points="790,629.2969,815,639.2969,790,649.2969,800,639.2969" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="195" x2="805" y1="639.2969" y2="639.2969"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="212.5" y="627.1558">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="447.5" x="342.5" y="627.1558">explicit card selection scenario</text><polygon fill="#0000FF" points="1522.5,827.8125,1547.5,837.8125,1522.5,847.8125,1532.5,837.8125" style="stroke:#0000FF;stroke-width:2.5;"/><line style="stroke:#0000FF;stroke-width:2.5;" x1="845" x2="1537.5" y1="837.8125" y2="837.8125"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="862.5" y="703.0347">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="345" x="992.5" y="703.0347">card selection scenario:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="62.5" x="942.5" y="743.9136">- aid</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="385" x="942.5" y="784.7925">- read record (environment)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="382.5" x="942.5" y="825.6714">- read record (contract list)</text><polygon fill="#A80036" points="2167.5,903.6914,2192.5,913.6914,2167.5,923.6914,2177.5,913.6914" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="913.6914" y2="913.6914"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="265" x="1595" y="901.5503">open card channel</text><polygon fill="#A80036" points="1605,938.6914,1580,948.6914,1605,958.6914,1595,948.6914" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="948.6914" y2="948.6914"/><polygon fill="#A80036" points="2167.5,1014.5703,2192.5,1024.5703,2167.5,1034.5703,2177.5,1024.5703" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="1024.5703" y2="1024.5703"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="325" x="1595" y="1012.4292">select application (aid)</text><polygon fill="#A80036" points="1605,1090.4492,1580,1100.4492,1605,1110.4492,1595,1100.4492" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="1100.4492" y2="1100.4492"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="142.5" x="1620" y="1088.3081">[card FCI]</text><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="1682.5" y1="1176.3281" y2="1176.3281"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1682.5" x2="1682.5" y1="1176.3281" y2="1208.8281"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1580" x2="1682.5" y1="1208.8281" y2="1208.8281"/><polygon fill="#A80036" points="1605,1198.8281,1580,1208.8281,1605,1218.8281,1595,1208.8281" style="stroke:#A80036;stroke-width:2.5;"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="372.5" x="1595" y="1164.187">checks invalidation status</text><path d="M1361.25,1246.3281 L2196.25,1246.3281 L2196.25,1266.3281 L2171.25,1291.3281 L1361.25,1291.3281 L1361.25,1246.3281 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.5;"/><rect fill="none" height="349.3945" style="stroke:#000000;stroke-width:5.0;" width="935" x="1361.25" y="1246.3281"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="722.5" x="1398.75" y="1282.5659">Card APDU commands outside secure session</text><polygon fill="#A80036" points="2167.5,1338.0859,2192.5,1348.0859,2167.5,1358.0859,2177.5,1348.0859" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="1348.0859" y2="1348.0859"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="365" x="1595" y="1335.9448">read record (environment)</text><polygon fill="#A80036" points="1605,1413.9648,1580,1423.9648,1605,1433.9648,1595,1423.9648" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="1423.9648" y2="1423.9648"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="265" x="1620" y="1411.8237">[environment data]</text><polygon fill="#A80036" points="2167.5,1489.8438,2192.5,1499.8438,2167.5,1509.8438,2177.5,1499.8438" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="1499.8438" y2="1499.8438"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="362.5" x="1595" y="1487.7026">read record (contract list)</text><polygon fill="#A80036" points="1605,1565.7227,1580,1575.7227,1605,1585.7227,1595,1575.7227" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="1575.7227" y2="1575.7227"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="262.5" x="1620" y="1563.5815">[contract list data]</text><polygon fill="#0000FF" points="872.5,1740.8594,847.5,1750.8594,872.5,1760.8594,862.5,1750.8594" style="stroke:#0000FF;stroke-width:2.5;"/><line style="stroke:#0000FF;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="857.5" x2="1562.5" y1="1750.8594" y2="1750.8594"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="142.5" x="887.5" y="1656.9604">[card FCI,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="255" x="897.5" y="1697.8394">environment data,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="252.5" x="897.5" y="1738.7183">contract list data]</text><polygon fill="#A80036" points="222.5,1939.375,197.5,1949.375,222.5,1959.375,212.5,1949.375" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="207.5" x2="830" y1="1949.375" y2="1949.375"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="307.5" x="237.5" y="1814.5972">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="390" x="317.5" y="1855.4761">- support identification data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="265" x="317.5" y="1896.355">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="272.5" x="317.5" y="1937.2339">- contract list data]</text><rect fill="#EEEEEE" height="7.5" style="stroke:#EEEEEE;stroke-width:2.5;" width="3148.75" x="0" y="2022.3145"/><line style="stroke:#000000;stroke-width:2.5;" x1="0" x2="3148.75" y1="2022.3145" y2="2022.3145"/><line style="stroke:#000000;stroke-width:2.5;" x1="0" x2="3148.75" y1="2029.8145" y2="2029.8145"/><rect fill="#EEEEEE" height="60.8789" style="stroke:#000000;stroke-width:5.0;" width="285" x="1431.875" y="1994.375"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="240" x="1446.875" y="2038.1128">SAM allocation</text><path d="M607.5,2092.7539 L607.5,2157.7539 L2522.5,2157.7539 L2522.5,2117.7539 L2497.5,2092.7539 L607.5,2092.7539 " fill="#FBFB77" style="stroke:#A80036;stroke-width:2.5;"/><path d="M2497.5,2092.7539 L2497.5,2117.7539 L2522.5,2117.7539 L2497.5,2092.7539 " fill="#FBFB77" style="stroke:#A80036;stroke-width:2.5;"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="1862.5" x="622.5" y="2138.9917">The allocation of a SAM is done in the same way as for a card, but it can be static (e.g. embedded SAM) or dynamic (e.g. HSM).</text><rect fill="#EEEEEE" height="7.5" style="stroke:#EEEEEE;stroke-width:2.5;" width="3148.75" x="0" y="2224.0723"/><line style="stroke:#000000;stroke-width:2.5;" x1="0" x2="3148.75" y1="2224.0723" y2="2224.0723"/><line style="stroke:#000000;stroke-width:2.5;" x1="0" x2="3148.75" y1="2231.5723" y2="2231.5723"/><rect fill="#EEEEEE" height="60.8789" style="stroke:#000000;stroke-width:5.0;" width="420" x="1364.375" y="2196.1328"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="375" x="1379.375" y="2239.8706">Card secure transaction</text><polygon fill="#A80036" points="790,2532.2852,815,2542.2852,790,2552.2852,800,2542.2852" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="195" x2="805" y1="2542.2852" y2="2542.2852"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="125" x="212.5" y="2325.7495">prepare</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="367.5" x="347.5" y="2325.7495">secured card transaction:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="345" x="292.5" y="2366.6284">- Calypso card resource</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="355" x="292.5" y="2407.5073">- Calypso SAM resource</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="315" x="292.5" y="2448.3862">- read environment file</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="255" x="292.5" y="2489.2651">- read contract #1</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="272.5" x="292.5" y="2530.144">- reader counter #1</text><polygon fill="#A80036" points="222.5,2567.2852,197.5,2577.2852,222.5,2587.2852,212.5,2577.2852" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="207.5" x2="830" y1="2577.2852" y2="2577.2852"/><polygon fill="#A80036" points="790,2643.1641,815,2653.1641,790,2663.1641,800,2653.1641" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="195" x2="805" y1="2653.1641" y2="2653.1641"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="212.5" y="2641.0229">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="422.5" x="342.5" y="2641.0229">opening (DEBIT access level)</text><polygon fill="#00FF00" points="2430,2800.8008,2455,2810.8008,2430,2820.8008,2440,2810.8008" style="stroke:#00FF00;stroke-width:2.5;"/><line style="stroke:#00FF00;stroke-width:2.5;" x1="845" x2="2445" y1="2810.8008" y2="2810.8008"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="862.5" y="2716.9019">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="190" x="992.5" y="2716.9019">card request:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="430" x="942.5" y="2757.7808">- select diversifier (card serial)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="212.5" x="942.5" y="2798.6597">- get challenge</text><polygon fill="#A80036" points="3032.5,2876.6797,3057.5,2886.6797,3032.5,2896.6797,3042.5,2886.6797" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="2886.6797" y2="2886.6797"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="410" x="2502.5" y="2874.5386">select diversifier (card serial)</text><polygon fill="#A80036" points="2512.5,2911.6797,2487.5,2921.6797,2512.5,2931.6797,2502.5,2921.6797" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="2921.6797" y2="2921.6797"/><polygon fill="#A80036" points="3032.5,2987.5586,3057.5,2997.5586,3032.5,3007.5586,3042.5,2997.5586" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="2997.5586" y2="2997.5586"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="192.5" x="2502.5" y="2985.4175">get challenge</text><polygon fill="#A80036" points="2512.5,3063.4375,2487.5,3073.4375,2512.5,3083.4375,2502.5,3073.4375" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="3073.4375" y2="3073.4375"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="240" x="2527.5" y="3061.2964">[SAM challenge]</text><polygon fill="#00FF00" points="872.5,3139.3164,847.5,3149.3164,872.5,3159.3164,862.5,3149.3164" style="stroke:#00FF00;stroke-width:2.5;"/><line style="stroke:#00FF00;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="857.5" x2="2470" y1="3149.3164" y2="3149.3164"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="240" x="887.5" y="3137.1753">[SAM challenge]</text><polygon fill="#0000FF" points="1522.5,3419.5898,1547.5,3429.5898,1522.5,3439.5898,1532.5,3429.5898" style="stroke:#0000FF;stroke-width:2.5;"/><line style="stroke:#0000FF;stroke-width:2.5;" x1="845" x2="1537.5" y1="3429.5898" y2="3429.5898"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="862.5" y="3213.0542">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="190" x="992.5" y="3213.0542">card request:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="555" x="942.5" y="3253.9331">- open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="230" x="1022.5" y="3294.812">SAM challenge,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="352.5" x="1022.5" y="3335.6909">SFI environment to read)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="375" x="942.5" y="3376.5698">- read record (contract #1)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="392.5" x="942.5" y="3417.4487">- reader record (counter #1)</text><path d="M1361.25,3467.0898 L2061.25,3467.0898 L2061.25,3487.0898 L2036.25,3512.0898 L1361.25,3512.0898 L1361.25,3467.0898 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.5;"/><rect fill="none" height="582.9102" style="stroke:#000000;stroke-width:5.0;" width="935" x="1361.25" y="3467.0898"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="587.5" x="1398.75" y="3503.3276">Card APDU commands inside session</text><polygon fill="#A80036" points="2167.5,3640.6055,2192.5,3650.6055,2167.5,3660.6055,2177.5,3650.6055" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="3650.6055" y2="3650.6055"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="535" x="1595" y="3556.7065">open secure session (card debit key,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="230" x="1675" y="3597.5854">SAM challenge,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="352.5" x="1675" y="3638.4644">SFI environment to read)</text><polygon fill="#A80036" points="1605,3716.4844,1580,3726.4844,1605,3736.4844,1595,3726.4844" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="3726.4844" y2="3726.4844"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="517.5" x="1620" y="3714.3433">[card challenge &amp; environment data]</text><polygon fill="#A80036" points="2167.5,3792.3633,2192.5,3802.3633,2167.5,3812.3633,2177.5,3802.3633" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="3802.3633" y2="3802.3633"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="355" x="1595" y="3790.2222">read record (contract #1)</text><polygon fill="#A80036" points="1605,3868.2422,1580,3878.2422,1605,3888.2422,1595,3878.2422" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="3878.2422" y2="3878.2422"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="255" x="1620" y="3866.1011">[contract #1 data]</text><polygon fill="#A80036" points="2167.5,3944.1211,2192.5,3954.1211,2167.5,3964.1211,2177.5,3954.1211" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="3954.1211" y2="3954.1211"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="345" x="1595" y="3941.98">read record (counter #1)</text><polygon fill="#A80036" points="1605,4020,1580,4030,1605,4040,1595,4030" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="4030" y2="4030"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="245" x="1620" y="4017.8589">[counter #1 data]</text><polygon fill="#0000FF" points="872.5,4195.1367,847.5,4205.1367,872.5,4215.1367,862.5,4205.1367" style="stroke:#0000FF;stroke-width:2.5;"/><line style="stroke:#0000FF;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="857.5" x2="1562.5" y1="4205.1367" y2="4205.1367"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="517.5" x="887.5" y="4111.2378">[card challenge &amp; environment data,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="245" x="897.5" y="4152.1167">contract #1 data,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="235" x="897.5" y="4192.9956">counter #1 data]</text><polygon fill="#A80036" points="222.5,4475.4102,197.5,4485.4102,222.5,4495.4102,212.5,4485.4102" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="207.5" x2="830" y1="4485.4102" y2="4485.4102"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="307.5" x="237.5" y="4268.8745">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="390" x="317.5" y="4309.7534">- support identification data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="410" x="317.5" y="4350.6323">- environment data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="262.5" x="317.5" y="4391.5112">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="255" x="317.5" y="4432.3901">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="255" x="317.5" y="4473.269">- counter #1 data]</text><polygon fill="#A80036" points="790,4673.9258,815,4683.9258,790,4693.9258,800,4683.9258" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="195" x2="805" y1="4683.9258" y2="4683.9258"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="125" x="212.5" y="4549.1479">prepare</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="10" x="337.5" y="4549.1479">:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="395" x="292.5" y="4590.0269">- update event record (data)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="417.5" x="292.5" y="4630.9058">- decrease counter #1 (value)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="247.5" x="292.5" y="4671.7847">- release channel</text><polygon fill="#A80036" points="222.5,4708.9258,197.5,4718.9258,222.5,4728.9258,212.5,4718.9258" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="207.5" x2="830" y1="4718.9258" y2="4718.9258"/><polygon fill="#A80036" points="790,4784.8047,815,4794.8047,790,4804.8047,800,4794.8047" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="195" x2="805" y1="4794.8047" y2="4794.8047"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="212.5" y="4782.6636">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="282.5" x="342.5" y="4782.6636">closing (not ratified)</text><line style="stroke:#A80036;stroke-width:2.5;" x1="845" x2="950" y1="4870.6836" y2="4870.6836"/><line style="stroke:#A80036;stroke-width:2.5;" x1="950" x2="950" y1="4870.6836" y2="4903.1836"/><line style="stroke:#A80036;stroke-width:2.5;" x1="847.5" x2="950" y1="4903.1836" y2="4903.1836"/><polygon fill="#A80036" points="872.5,4893.1836,847.5,4903.1836,872.5,4913.1836,862.5,4903.1836" style="stroke:#A80036;stroke-width:2.5;"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="522.5" x="862.5" y="4858.5425">Anticipate the future card responses</text><polygon fill="#00FF00" points="2430,5214.3359,2455,5224.3359,2430,5234.3359,2440,5224.3359" style="stroke:#00FF00;stroke-width:2.5;"/><line style="stroke:#00FF00;stroke-width:2.5;" x1="845" x2="2445" y1="5224.3359" y2="5224.3359"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="862.5" y="4966.9214">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="190" x="992.5" y="4966.9214">card request:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="687.5" x="942.5" y="5007.8003">- digest init (card challenge &amp; environment data)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="480" x="942.5" y="5048.6792">- digest update (read contract #1)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="470" x="942.5" y="5089.5581">- digest update (read counter #1)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="620" x="942.5" y="5130.437">- digest update (update event record (data))</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="597.5" x="942.5" y="5171.3159">- digest update (decrease counter (value))</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="195" x="942.5" y="5212.1948">- digest close</text><polygon fill="#A80036" points="3032.5,5290.2148,3057.5,5300.2148,3032.5,5310.2148,3042.5,5300.2148" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="5300.2148" y2="5300.2148"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="355" x="2502.5" y="5288.0737">digest init (opening data)</text><polygon fill="#A80036" points="2512.5,5325.2148,2487.5,5335.2148,2512.5,5345.2148,2502.5,5335.2148" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="5335.2148" y2="5335.2148"/><polygon fill="#A80036" points="3032.5,5401.0938,3057.5,5411.0938,3032.5,5421.0938,3042.5,5411.0938" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="5411.0938" y2="5411.0938"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="415" x="2502.5" y="5398.9526">digest update (read contract)</text><polygon fill="#A80036" points="2512.5,5436.0938,2487.5,5446.0938,2512.5,5456.0938,2502.5,5446.0938" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="5446.0938" y2="5446.0938"/><polygon fill="#A80036" points="3032.5,5511.9727,3057.5,5521.9727,3032.5,5531.9727,3042.5,5521.9727" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="5521.9727" y2="5521.9727"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="405" x="2502.5" y="5509.8315">digest update (read counter)</text><polygon fill="#A80036" points="2512.5,5546.9727,2487.5,5556.9727,2512.5,5566.9727,2502.5,5556.9727" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="5556.9727" y2="5556.9727"/><polygon fill="#A80036" points="3032.5,5622.8516,3057.5,5632.8516,3032.5,5642.8516,3042.5,5632.8516" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="5632.8516" y2="5632.8516"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="507.5" x="2502.5" y="5620.7104">digest update (update event record)</text><polygon fill="#A80036" points="2512.5,5657.8516,2487.5,5667.8516,2512.5,5677.8516,2502.5,5667.8516" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="5667.8516" y2="5667.8516"/><polygon fill="#A80036" points="3032.5,5733.7305,3057.5,5743.7305,3032.5,5753.7305,3042.5,5743.7305" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="5743.7305" y2="5743.7305"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="475" x="2502.5" y="5731.5894">digest update (decrease counter)</text><polygon fill="#A80036" points="2512.5,5768.7305,2487.5,5778.7305,2512.5,5788.7305,2502.5,5778.7305" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="5778.7305" y2="5778.7305"/><polygon fill="#A80036" points="3032.5,5844.6094,3057.5,5854.6094,3032.5,5864.6094,3042.5,5854.6094" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="5854.6094" y2="5854.6094"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="175" x="2502.5" y="5842.4683">digest close</text><polygon fill="#A80036" points="2512.5,5920.4883,2487.5,5930.4883,2512.5,5940.4883,2502.5,5930.4883" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="5930.4883" y2="5930.4883"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="242.5" x="2527.5" y="5918.3472">[SAM certificate]</text><polygon fill="#00FF00" points="872.5,6078.125,847.5,6088.125,872.5,6098.125,862.5,6088.125" style="stroke:#00FF00;stroke-width:2.5;"/><line style="stroke:#00FF00;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="857.5" x2="2470" y1="6088.125" y2="6088.125"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="260" x="887.5" y="5994.2261">[digest init status,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="195" x="897.5" y="6035.105">digest update</text><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="15" x="1092.5" y="6035.105">s</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="100" x="1117.5" y="6035.105">status,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="627.5" x="897.5" y="6075.9839">digest close response with SAM certificate]</text><polygon fill="#0000FF" points="1522.5,6317.5195,1547.5,6327.5195,1522.5,6337.5195,1532.5,6327.5195" style="stroke:#0000FF;stroke-width:2.5;"/><line style="stroke:#0000FF;stroke-width:2.5;" x1="845" x2="1537.5" y1="6327.5195" y2="6327.5195"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="862.5" y="6151.8628">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="190" x="992.5" y="6151.8628">card request:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="405" x="942.5" y="6192.7417">- update record (event, data)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="545" x="942.5" y="6233.6206">- decrease counter (counter #1, value)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="580" x="942.5" y="6274.4995">- close secure session (SAM certificate)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="320" x="942.5" y="6315.3784">- ratification command</text><path d="M1361.25,6365.0195 L2061.25,6365.0195 L2061.25,6385.0195 L2036.25,6410.0195 L1361.25,6410.0195 L1361.25,6365.0195 " fill="#EEEEEE" style="stroke:#000000;stroke-width:2.5;"/><rect fill="none" height="308.5156" style="stroke:#000000;stroke-width:5.0;" width="935" x="1361.25" y="6365.0195"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="587.5" x="1398.75" y="6401.2573">Card APDU commands inside session</text><polygon fill="#A80036" points="2167.5,6456.7773,2192.5,6466.7773,2167.5,6476.7773,2177.5,6466.7773" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="6466.7773" y2="6466.7773"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="385" x="1595" y="6454.6362">update record (event, data)</text><polygon fill="#A80036" points="1605,6491.7773,1580,6501.7773,1605,6511.7773,1595,6501.7773" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="6501.7773" y2="6501.7773"/><polygon fill="#A80036" points="2167.5,6567.6563,2192.5,6577.6563,2167.5,6587.6563,2177.5,6577.6563" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="6577.6563" y2="6577.6563"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="525" x="1595" y="6565.5151">decrease counter (counter #1, value)</text><polygon fill="#A80036" points="1605,6643.5352,1580,6653.5352,1605,6663.5352,1595,6653.5352" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="6653.5352" y2="6653.5352"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="277.5" x="1620" y="6641.394">[new counter value]</text><polygon fill="#A80036" points="2167.5,6736.9141,2192.5,6746.9141,2167.5,6756.9141,2177.5,6746.9141" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="6746.9141" y2="6746.9141"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="560" x="1595" y="6734.7729">close secure session (SAM certificate)</text><polygon fill="#A80036" points="1605,6812.793,1580,6822.793,1605,6832.793,1595,6822.793" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="6822.793" y2="6822.793"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="232.5" x="1620" y="6810.6519">[card certificate]</text><polygon fill="#A80036" points="2167.5,6888.6719,2192.5,6898.6719,2167.5,6908.6719,2177.5,6898.6719" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="6898.6719" y2="6898.6719"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="300" x="1595" y="6886.5308">ratification command</text><polygon fill="#A80036" points="1605,6923.6719,1580,6933.6719,1605,6943.6719,1595,6933.6719" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2195" y1="6933.6719" y2="6933.6719"/><polygon fill="#A80036" points="2167.5,6999.5508,2192.5,7009.5508,2167.5,7019.5508,2177.5,7009.5508" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="1577.5" x2="2182.5" y1="7009.5508" y2="7009.5508"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="272.5" x="1595" y="6997.4097">close card channel</text><polygon fill="#A80036" points="1605,7034.5508,1580,7044.5508,1605,7054.5508,1595,7044.5508" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="1590" x2="2207.5" y1="7044.5508" y2="7044.5508"/><polygon fill="#0000FF" points="872.5,7233.0664,847.5,7243.0664,872.5,7253.0664,862.5,7243.0664" style="stroke:#0000FF;stroke-width:2.5;"/><line style="stroke:#0000FF;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="857.5" x2="1562.5" y1="7243.0664" y2="7243.0664"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="317.5" x="887.5" y="7108.2886">[update record status,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="312.5" x="897.5" y="7149.1675">new counter #1 value,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="222.5" x="897.5" y="7190.0464">card certificate,</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="257.5" x="897.5" y="7230.9253">ratification status]</text><polygon fill="#00FF00" points="2430,7349.8242,2455,7359.8242,2430,7369.8242,2440,7359.8242" style="stroke:#00FF00;stroke-width:2.5;"/><line style="stroke:#00FF00;stroke-width:2.5;" x1="845" x2="2445" y1="7359.8242" y2="7359.8242"/><text fill="#000000" font-family="sans-serif" font-size="32.5" font-weight="bold" lengthAdjust="spacing" textLength="120" x="862.5" y="7306.8042">process</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="190" x="992.5" y="7306.8042">card request:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="537.5" x="942.5" y="7347.6831">- digest authenticate (card certificate)</text><polygon fill="#A80036" points="3032.5,7425.7031,3057.5,7435.7031,3032.5,7445.7031,3042.5,7435.7031" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;" x1="2485" x2="3047.5" y1="7435.7031" y2="7435.7031"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="517.5" x="2502.5" y="7423.562">digest authenticate (card certificate)</text><polygon fill="#A80036" points="2512.5,7501.582,2487.5,7511.582,2512.5,7521.582,2502.5,7511.582" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="2497.5" x2="3060" y1="7511.582" y2="7511.582"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="322.5" x="2527.5" y="7499.4409">[authentication status]</text><polygon fill="#00FF00" points="872.5,7577.4609,847.5,7587.4609,872.5,7597.4609,862.5,7587.4609" style="stroke:#00FF00;stroke-width:2.5;"/><line style="stroke:#00FF00;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="857.5" x2="2470" y1="7587.4609" y2="7587.4609"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="337.5" x="887.5" y="7575.3198">[authentification status]</text><polygon fill="#A80036" points="222.5,7898.6133,197.5,7908.6133,222.5,7918.6133,212.5,7908.6133" style="stroke:#A80036;stroke-width:2.5;"/><line style="stroke:#A80036;stroke-width:2.5;stroke-dasharray:2.0,2.0;" x1="207.5" x2="830" y1="7908.6133" y2="7908.6133"/><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="307.5" x="237.5" y="7651.1987">[Calypso card image:</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="390" x="317.5" y="7692.0776">- support identification data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="265" x="317.5" y="7732.9565">- environment data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="262.5" x="317.5" y="7773.8354">- contract list data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="255" x="317.5" y="7814.7144">- contract #1 data</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="390" x="317.5" y="7855.5933">- counter #1 data (updated)</text><text fill="#000000" font-family="sans-serif" font-size="32.5" lengthAdjust="spacing" textLength="150" x="317.5" y="7896.4722">- event #1]</text><!--MD5=[a0c737beca4202d1cdc3efe2d42aec2d]
@startuml

'skinparam ClassBorderColor #F1C40F
skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

' Red
skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
' Purple
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
' blue
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
' Green
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

' Orange
skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

' Grey
skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Keyple Core Services\nCalypso Card Extension" as core #pink
participant "Keyple Card Reader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Keyple SAM Reader" as samReader #lightGreen
boundary "**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

app->core: **prepare** card selection scenario:\n\t- filter by specific AID\n\t- read environment file\n\t- read contracts list file
activate core  #pink
core- ->app
deactivate core

app->core: **process** explicit card selection scenario
activate core  #pink
core-[#0000FF]>cardReader: **process** card selection scenario:\n\t- aid\n\t- read record (environment)\n\t- read record (contract list)
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

group Card APDU commands outside secure session
    cardReader->card: read record (environment)
    card- ->cardReader: [environment data]
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>core: [card FCI,\n environment data,\n contract list data]
deactivate cardReader

core- ->app: [Calypso card image:\n\t- support identification data\n\t- environment data\n\t- contract list data]
deactivate core

== SAM allocation ==

note over cardReader
    The allocation of a SAM is done in the same way as for a card, but it can be static (e.g. embedded SAM) or dynamic (e.g. HSM).
end note

== Card secure transaction ==

app->core: **prepare** secured card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource\n\t- read environment file\n\t- read contract #1\n\t- reader counter #1
activate core  #pink
core- ->app
deactivate core

app->core: **process** opening (DEBIT access level)
activate core  #pink

core-[#00FF00]>samReader: **process** card request:\n\t- select diversifier (card serial)\n\t- get challenge
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->core: [SAM challenge]
deactivate samReader

core-[#0000FF]>cardReader: **process** card request:\n\t- open secure session (card debit key,\n\t\tSAM challenge,\n\t\tSFI environment to read)\n\t- read record (contract #1)\n\t- reader record (counter #1)
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
    cardReader->card: read record (contract #1)
    card- ->cardReader: [contract #1 data]
    cardReader->card: read record (counter #1)
    card- ->cardReader: [counter #1 data]
end

cardReader- -[#0000FF]>core: [card challenge & environment data,\n contract #1 data,\n counter #1 data]
deactivate cardReader

core- ->app: [Calypso card image:\n\t- support identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate core

app->core: **prepare**:\n\t- update event record (data)\n\t- decrease counter #1 (value)\n\t- release channel
activate core  #pink
core- ->app
deactivate core

app->core: **process** closing (not ratified)
activate core  #pink
core->core: Anticipate the future card responses

core-[#00FF00]>samReader: **process** card request:\n\t- digest init (card challenge & environment data)\n\t- digest update (read contract #1)\n\t- digest update (read counter #1)\n\t- digest update (update event record (data))\n\t- digest update (decrease counter (value))\n\t- digest close
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read contract)
sam- ->samReader
samReader->sam: digest update (read counter)
sam- ->samReader
samReader->sam: digest update (update event record)
sam- ->samReader
samReader->sam: digest update (decrease counter)
sam- ->samReader
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->core: [digest init status,\n digest update**s** status,\n digest close response with SAM certificate]
deactivate samReader


core-[#0000FF]>cardReader: **process** card request:\n\t- update record (event, data)\n\t- decrease counter (counter #1, value)\n\t- close secure session (SAM certificate)\n\t- ratification command
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: update record (event, data)
    card- ->cardReader
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
end

cardReader->card: close secure session (SAM certificate)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->core: [update record status,\n new counter #1 value,\n card certificate,\n ratification status]
deactivate cardReader

core-[#00FF00]>samReader: **process** card request:\n\t- digest authenticate (card certificate)
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->core: [authentification status]
deactivate samReader

core- ->app: [Calypso card image:\n\t- support identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1]
deactivate core
@enduml

@startuml

skinparam ClassBorderColor #D4AC0D
skinparam stereotypeABorderColor #A9DCDF
skinparam stereotypeIBorderColor #B4A7E5
skinparam stereotypeCBorderColor #ADD1B2
skinparam stereotypeEBorderColor #EB93DF
skinparam shadowing false

skinparam StateBorderColor #D4AC0D
skinparam ActivityBorderColor #D4AC0D

skinparam ClassBackgroundColor<<red>> #FDEDEC
skinparam ClassBorderColor<<red>> #E74C3C
hide <<red>> stereotype
skinparam ClassBackgroundColor<<purple>> #F4ECF7
skinparam ClassBorderColor<<purple>> #8E44AD
hide <<purple>> stereotype
skinparam ClassBackgroundColor<<blue>> #EBF5FB
skinparam ClassBorderColor<<blue>> #3498DB
hide <<blue>> stereotype
skinparam ClassBackgroundColor<<green>> #EAFAF1
skinparam ClassBorderColor<<green>> #2ECC71
hide <<green>> stereotype

skinparam ClassBackgroundColor<<orange>> #FDF2E9
skinparam ClassBorderColor<<orange>> #E67E22
hide <<orange>> stereotype

skinparam ClassBackgroundColor<<grey>> #EAECEE
skinparam ClassBorderColor<<grey>> #2C3E50
hide <<grey>> stereotype

actor "Ticketing Application" as app #gold
participant "Keyple Core Services\nCalypso Card Extension" as core #pink
participant "Keyple Card Reader" as cardReader #lightBlue
boundary "**Card**" as card #lightBlue
participant "Keyple SAM Reader" as samReader #lightGreen
boundary "**SAM**" as sam #lightGreen

activate app #gold
activate sam #lightGreen

== Card selection & identification ==

app->core: **prepare** card selection scenario:\n\t- filter by specific AID\n\t- read environment file\n\t- read contracts list file
activate core  #pink
core- ->app
deactivate core

app->core: **process** explicit card selection scenario
activate core  #pink
core-[#0000FF]>cardReader: **process** card selection scenario:\n\t- aid\n\t- read record (environment)\n\t- read record (contract list)
activate cardReader #lightBlue

cardReader->card: open card channel
activate card #lightBlue
card- ->cardReader
cardReader->card: select application (aid)
card- ->cardReader: [card FCI]
cardReader->cardReader: checks invalidation status

group Card APDU commands outside secure session
    cardReader->card: read record (environment)
    card- ->cardReader: [environment data]
    cardReader->card: read record (contract list)
    card- ->cardReader: [contract list data]
end

cardReader- -[#0000FF]>core: [card FCI,\n environment data,\n contract list data]
deactivate cardReader

core- ->app: [Calypso card image:\n\t- support identification data\n\t- environment data\n\t- contract list data]
deactivate core

== SAM allocation ==

note over cardReader
    The allocation of a SAM is done in the same way as for a card, but it can be static (e.g. embedded SAM) or dynamic (e.g. HSM).
end note

== Card secure transaction ==

app->core: **prepare** secured card transaction:\n\t- Calypso card resource\n\t- Calypso SAM resource\n\t- read environment file\n\t- read contract #1\n\t- reader counter #1
activate core  #pink
core- ->app
deactivate core

app->core: **process** opening (DEBIT access level)
activate core  #pink

core-[#00FF00]>samReader: **process** card request:\n\t- select diversifier (card serial)\n\t- get challenge
activate samReader #lightGreen
samReader->sam: select diversifier (card serial)
sam- ->samReader
samReader->sam: get challenge
sam- ->samReader: [SAM challenge]
samReader-[#00FF00]->core: [SAM challenge]
deactivate samReader

core-[#0000FF]>cardReader: **process** card request:\n\t- open secure session (card debit key,\n\t\tSAM challenge,\n\t\tSFI environment to read)\n\t- read record (contract #1)\n\t- reader record (counter #1)
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: open secure session (card debit key,\n\tSAM challenge,\n\tSFI environment to read)
    card- ->cardReader: [card challenge & environment data]
    cardReader->card: read record (contract #1)
    card- ->cardReader: [contract #1 data]
    cardReader->card: read record (counter #1)
    card- ->cardReader: [counter #1 data]
end

cardReader- -[#0000FF]>core: [card challenge & environment data,\n contract #1 data,\n counter #1 data]
deactivate cardReader

core- ->app: [Calypso card image:\n\t- support identification data\n\t- environment data (updated)\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data]
deactivate core

app->core: **prepare**:\n\t- update event record (data)\n\t- decrease counter #1 (value)\n\t- release channel
activate core  #pink
core- ->app
deactivate core

app->core: **process** closing (not ratified)
activate core  #pink
core->core: Anticipate the future card responses

core-[#00FF00]>samReader: **process** card request:\n\t- digest init (card challenge & environment data)\n\t- digest update (read contract #1)\n\t- digest update (read counter #1)\n\t- digest update (update event record (data))\n\t- digest update (decrease counter (value))\n\t- digest close
activate samReader #lightGreen

samReader->sam: digest init (opening data)
sam- ->samReader
samReader->sam: digest update (read contract)
sam- ->samReader
samReader->sam: digest update (read counter)
sam- ->samReader
samReader->sam: digest update (update event record)
sam- ->samReader
samReader->sam: digest update (decrease counter)
sam- ->samReader
samReader->sam: digest close
sam- ->samReader: [SAM certificate]

samReader-[#00FF00]->core: [digest init status,\n digest update**s** status,\n digest close response with SAM certificate]
deactivate samReader


core-[#0000FF]>cardReader: **process** card request:\n\t- update record (event, data)\n\t- decrease counter (counter #1, value)\n\t- close secure session (SAM certificate)\n\t- ratification command
activate cardReader #lightBlue

group Card APDU commands inside session
    cardReader->card: update record (event, data)
    card- ->cardReader
    cardReader->card: decrease counter (counter #1, value)
    card- ->cardReader: [new counter value]
end

cardReader->card: close secure session (SAM certificate)
card- ->cardReader: [card certificate]
cardReader->card: ratification command
card- ->cardReader
cardReader->card: close card channel
card- ->cardReader
deactivate card

cardReader-[#0000FF]->core: [update record status,\n new counter #1 value,\n card certificate,\n ratification status]
deactivate cardReader

core-[#00FF00]>samReader: **process** card request:\n\t- digest authenticate (card certificate)
activate samReader #lightGreen
samReader->sam: digest authenticate (card certificate)
sam- ->samReader: [authentication status]

samReader-[#00FF00]->core: [authentification status]
deactivate samReader

core- ->app: [Calypso card image:\n\t- support identification data\n\t- environment data\n\t- contract list data\n\t- contract #1 data\n\t- counter #1 data (updated)\n\t- event #1]
deactivate core
@enduml

PlantUML version 1.2021.7(Sun May 23 14:40:07 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: Cp1252
Language: fr
Country: FR
--></g></svg>